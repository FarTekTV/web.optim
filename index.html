<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPTIM — Image Optimizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0f;
    --surface: #161618;
    --border: #2a2a2e;
    --accent: #c8ff00;
    --accent2: #ff6b35;
    --text: #e8e8e6;
    --muted: #6b6b72;
    --success: #3dffa0;
    --mono: 'Space Mono', monospace;
    --display: 'Syne', sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--mono); font-size: 13px; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(200,255,0,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(200,255,0,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  .wrap { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 40px 24px 80px; }
  header { display: flex; align-items: baseline; gap: 20px; margin-bottom: 48px; }
  .logo { font-family: var(--display); font-size: 36px; font-weight: 800; letter-spacing: -1px; color: var(--accent); line-height: 1; }
  .logo span { color: var(--text); }
  .tagline { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; padding-top: 4px; }
  .version { margin-left: auto; font-size: 11px; color: var(--muted); border: 1px solid var(--border); padding: 4px 10px; border-radius: 2px; }

  #drop-zone {
    border: 2px dashed var(--border); border-radius: 4px; padding: 60px 40px; text-align: center;
    cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;
    margin-bottom: 32px; background: var(--surface);
  }
  #drop-zone::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(200,255,0,0.04) 0%, transparent 70%);
    opacity: 0; transition: opacity 0.3s;
  }
  #drop-zone:hover::before, #drop-zone.drag-over::before { opacity: 1; }
  #drop-zone:hover, #drop-zone.drag-over { border-color: var(--accent); transform: translateY(-1px); }
  #drop-zone.drag-over { border-style: solid; background: rgba(200,255,0,0.03); }
  .drop-icon { width: 52px; height: 52px; margin: 0 auto 20px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: all 0.2s; }
  #drop-zone:hover .drop-icon { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }
  .drop-title { font-family: var(--display); font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
  .drop-sub { color: var(--muted); font-size: 12px; margin-bottom: 20px; line-height: 1.6; }

  .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-family: var(--mono); font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border-radius: 2px; transition: all 0.15s; border: none; text-decoration: none; }
  .btn-accent { background: var(--accent); color: #0e0e0f; }
  .btn-accent:hover { background: #d4ff1a; transform: translateY(-1px); }
  .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-success { background: var(--success); color: #0e0e0f; }
  .btn-success:hover { filter: brightness(1.1); }
  #file-input { display: none; }

  .editor { display: none; gap: 28px; grid-template-columns: 1fr 340px; }
  .editor.visible { display: grid; animation: fadein 0.3s ease; }
  .preview-panel { display: flex; flex-direction: column; gap: 16px; }
  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); }
  .panel-header .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); display: inline-block; margin-right: 8px; }
  .panel-body { padding: 16px; }

  .tab-bar { display: flex; gap: 2px; padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .tab { padding: 5px 14px; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border-radius: 2px; color: var(--muted); background: none; border: 1px solid transparent; font-family: var(--mono); transition: all 0.15s; }
  .tab.active { color: var(--accent); border-color: var(--accent); background: rgba(200,255,0,0.05); }
  .tab:hover:not(.active) { color: var(--text); }

  .preview-area { padding: 16px; min-height: 300px; display: flex; align-items: center; justify-content: center; background: repeating-conic-gradient(#1a1a1c 0% 25%, #141415 0% 50%) 0 0 / 20px 20px; }
  .preview-area img, .preview-area canvas { max-width: 100%; max-height: 420px; object-fit: contain; display: block; }

  .stats-bar { display: flex; border-top: 1px solid var(--border); }
  .stat { flex: 1; padding: 12px 16px; border-right: 1px solid var(--border); text-align: center; }
  .stat:last-child { border-right: none; }
  .stat-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .stat-value { font-family: var(--display); font-size: 16px; font-weight: 700; color: var(--text); }
  .stat-value.saved { color: var(--success); }
  .stat-value.up { color: var(--accent2); }

  .controls { display: flex; flex-direction: column; gap: 16px; }
  .control-group { background: var(--surface); border: 1px solid var(--border); border-radius: 4px; }
  .control-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; display: block; }

  .slider-row { display: flex; align-items: center; gap: 12px; }
  input[type="range"] { -webkit-appearance: none; flex: 1; height: 3px; background: var(--border); border-radius: 2px; cursor: pointer; outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }
  .slider-val { font-size: 16px; font-family: var(--display); font-weight: 700; color: var(--accent); min-width: 36px; text-align: right; }

  .format-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
  .format-btn { padding: 8px; background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: var(--mono); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border-radius: 2px; transition: all 0.15s; }
  .format-btn:hover { border-color: var(--text); color: var(--text); }
  .format-btn.active { background: rgba(200,255,0,0.08); border-color: var(--accent); color: var(--accent); }

  .dim-row { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; }
  .dim-row .x { color: var(--muted); text-align: center; font-size: 12px; }
  input[type="number"] { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; color: var(--text); font-family: var(--mono); font-size: 13px; padding: 8px 10px; outline: none; transition: border-color 0.15s; -moz-appearance: textfield; }
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
  input[type="number"]:focus { border-color: var(--accent); }

  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; }
  .toggle-label { font-size: 12px; color: var(--text); }
  .toggle-label small { display: block; color: var(--muted); font-size: 10px; margin-top: 2px; }
  .toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
  .toggle input { display: none; }
  .toggle-track { position: absolute; inset: 0; background: var(--border); border-radius: 20px; cursor: pointer; transition: background 0.2s; }
  .toggle-track::after { content: ''; position: absolute; width: 14px; height: 14px; left: 3px; top: 3px; background: var(--muted); border-radius: 50%; transition: all 0.2s; }
  .toggle input:checked + .toggle-track { background: rgba(200,255,0,0.2); }
  .toggle input:checked + .toggle-track::after { transform: translateX(16px); background: var(--accent); }

  select { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; color: var(--text); font-family: var(--mono); font-size: 12px; padding: 8px 10px; outline: none; cursor: pointer; transition: border-color 0.15s; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b6b72'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
  select:focus { border-color: var(--accent); }

  .progress-wrap { display: none; background: var(--border); border-radius: 2px; height: 3px; overflow: hidden; }
  .progress-wrap.visible { display: block; }
  .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; border-radius: 2px; }

  .compare-wrap { position: relative; overflow: hidden; cursor: col-resize; user-select: none; }
  .compare-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent); transform: translateX(-50%); pointer-events: none; }
  .compare-handle { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #0e0e0f; pointer-events: none; font-weight: 900; box-shadow: 0 2px 12px rgba(200,255,0,0.4); }
  .compare-label { position: absolute; top: 10px; font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 2px; pointer-events: none; }
  .compare-label.left { left: 10px; color: var(--accent2); border: 1px solid var(--accent2); }
  .compare-label.right { right: 10px; color: var(--accent); border: 1px solid var(--accent); }

  #histogram-canvas { width: 100%; height: 80px; display: block; border-radius: 2px; }

  .alert { padding: 10px 14px; border-radius: 2px; font-size: 12px; margin-bottom: 12px; display: none; gap: 8px; align-items: center; }
  .alert.visible { display: flex; }
  .alert-success { background: rgba(61,255,160,0.1); border: 1px solid rgba(61,255,160,0.3); color: var(--success); }

  .sep { height: 1px; background: var(--border); margin: 4px 0; }

  .file-strip { display: none; align-items: center; gap: 14px; padding: 10px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 16px; font-size: 12px; }
  .file-strip.visible { display: flex; }
  .file-strip .fname { color: var(--text); font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
  .file-strip .fsize { color: var(--muted); }
  .file-strip .ftype { background: rgba(255,107,53,0.15); color: var(--accent2); border: 1px solid rgba(255,107,53,0.3); padding: 2px 8px; border-radius: 2px; font-size: 10px; letter-spacing: 1px; font-weight: 700; }
  .file-strip .change-btn { margin-left: auto; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(14,14,15,0.3); border-top-color: #0e0e0f; border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes fadein { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  @media (max-width: 780px) { .editor.visible { grid-template-columns: 1fr; } header { flex-wrap: wrap; } }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="logo">OPTIM<span>.</span></div>
      <div class="tagline">Image Optimizer — 100% Client Side</div>
    </div>
    <div class="version">v1.0.0</div>
  </header>

  <div id="drop-zone">
    <div class="drop-icon">⬆</div>
    <div class="drop-title">Drop an image here</div>
    <div class="drop-sub">
      JPG, PNG, WebP, BMP, TIFF supported<br>
      100% local processing — nothing is uploaded to any server
    </div>
    <button class="btn btn-accent" onclick="document.getElementById('file-input').click()">⊕ Browse files</button>
    <input type="file" id="file-input" accept="image/*">
  </div>

  <div class="file-strip" id="file-strip">
    <span class="ftype" id="file-type-badge">JPG</span>
    <span class="fname" id="file-name">image.jpg</span>
    <span class="fsize" id="file-size-orig">— KB</span>
    <button class="btn btn-ghost change-btn" onclick="document.getElementById('file-input').click()" style="padding:6px 14px">↺ Change</button>
  </div>

  <div class="editor" id="editor">
    <!-- Left: Preview -->
    <div class="preview-panel">
      <div class="panel">
        <div class="tab-bar">
          <button class="tab active" onclick="switchTab('original')">Original</button>
          <button class="tab" onclick="switchTab('optimized')">Optimized</button>
          <button class="tab" onclick="switchTab('compare')">Compare ↔</button>
        </div>
        <div class="preview-area" id="preview-area">
          <img id="preview-img" src="" alt="preview" style="display:none">
          <canvas id="optimized-canvas" style="display:none"></canvas>
          <div id="compare-wrap" class="compare-wrap" style="display:none;width:100%">
            <canvas id="compare-canvas"></canvas>
          </div>
        </div>
        <div class="stats-bar">
          <div class="stat"><div class="stat-label">Original</div><div class="stat-value up" id="stat-orig">—</div></div>
          <div class="stat"><div class="stat-label">Optimized</div><div class="stat-value" id="stat-new">—</div></div>
          <div class="stat"><div class="stat-label">Savings</div><div class="stat-value saved" id="stat-saved">—</div></div>
          <div class="stat"><div class="stat-label">Dimensions</div><div class="stat-value" id="stat-dims">—</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span><span class="dot"></span>Histogram</span><span style="font-size:10px">RGB</span></div>
        <div class="panel-body" style="padding:12px"><canvas id="histogram-canvas"></canvas></div>
      </div>
    </div>

    <!-- Right: Controls -->
    <div class="controls">

      <div class="control-group">
        <div class="panel-header"><span><span class="dot" style="background:var(--accent2)"></span>Output format</span></div>
        <div class="panel-body">
          <div class="format-grid">
            <button class="format-btn active" data-fmt="image/jpeg" onclick="setFormat(this)">JPG</button>
            <button class="format-btn" data-fmt="image/webp" onclick="setFormat(this)">WebP</button>
            <button class="format-btn" data-fmt="image/png" onclick="setFormat(this)">PNG</button>
            <button class="format-btn" disabled style="opacity:0.3;cursor:not-allowed">GIF</button>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Quality & Compression</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:16px">
          <div>
            <label class="control-label">Quality <span id="quality-tip" style="color:var(--accent);font-size:9px;letter-spacing:1px">STANDARD</span></label>
            <div class="slider-row">
              <input type="range" id="quality-slider" min="1" max="100" value="82" oninput="onQualityChange(this)">
              <div class="slider-val" id="quality-val">82</div>
            </div>
          </div>
          <div>
            <label class="control-label">Compression method</label>
            <select id="compress-method" onchange="scheduleOptimize()">
              <option value="default">Auto (recommended)</option>
              <option value="aggressive">Aggressive — max compression</option>
              <option value="lossless">Lossless — no quality loss</option>
              <option value="balanced">Balanced</option>
            </select>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Resize</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          <div class="toggle-row">
            <div class="toggle-label">Enable resize<small>Scale down the output</small></div>
            <label class="toggle"><input type="checkbox" id="resize-toggle" onchange="toggleResize(this)"><span class="toggle-track"></span></label>
          </div>
          <div id="resize-fields" style="display:none;flex-direction:column;gap:10px">
            <div class="dim-row">
              <div>
                <label class="control-label" style="margin-bottom:6px">Width</label>
                <input type="number" id="resize-w" placeholder="px" oninput="onDimChange('w')">
              </div>
              <div class="x">×</div>
              <div>
                <label class="control-label" style="margin-bottom:6px">Height</label>
                <input type="number" id="resize-h" placeholder="px" oninput="onDimChange('h')">
              </div>
            </div>
            <div class="toggle-row">
              <div class="toggle-label">Lock aspect ratio<small>Keep proportions</small></div>
              <label class="toggle"><input type="checkbox" id="ratio-lock" checked><span class="toggle-track"></span></label>
            </div>
            <div>
              <label class="control-label">Resize algorithm</label>
              <select id="resize-algo" onchange="scheduleOptimize()">
                <option value="default">Bicubic (default)</option>
                <option value="smooth">High quality smooth</option>
                <option value="pixelated">Pixelated (pixel art)</option>
              </select>
            </div>
            <div>
              <label class="control-label">Quick presets</label>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
                <button class="format-btn" onclick="applyPreset(1920,1080)">1080p</button>
                <button class="format-btn" onclick="applyPreset(1280,720)">720p</button>
                <button class="format-btn" onclick="applyPreset(800,600)">800px</button>
                <button class="format-btn" onclick="applyPreset(400,400)">400px</button>
                <button class="format-btn" onclick="applyPreset(200,200)">Thumb</button>
                <button class="format-btn" onclick="applyPreset(null,null,'50%')">×½</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Image adjustments</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          <div>
            <label class="control-label">Sharpness</label>
            <div class="slider-row">
              <input type="range" id="sharpen-slider" min="0" max="100" value="0" oninput="updateSlider(this,'sharpen-val');scheduleOptimize()">
              <div class="slider-val" id="sharpen-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Brightness</label>
            <div class="slider-row">
              <input type="range" id="bright-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'bright-val');scheduleOptimize()">
              <div class="slider-val" id="bright-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Contrast</label>
            <div class="slider-row">
              <input type="range" id="contrast-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'contrast-val');scheduleOptimize()">
              <div class="slider-val" id="contrast-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Saturation</label>
            <div class="slider-row">
              <input type="range" id="sat-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'sat-val');scheduleOptimize()">
              <div class="slider-val" id="sat-val">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Advanced options</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <div class="toggle-row">
            <div class="toggle-label">Strip EXIF metadata<small>GPS, device, date, etc.</small></div>
            <label class="toggle"><input type="checkbox" id="strip-exif" checked><span class="toggle-track"></span></label>
          </div>
          <div class="sep"></div>
          <div class="toggle-row">
            <div class="toggle-label">Progressive JPEG<small>Progressive loading</small></div>
            <label class="toggle"><input type="checkbox" id="progressive" onchange="scheduleOptimize()"><span class="toggle-track"></span></label>
          </div>
          <div class="sep"></div>
          <div class="toggle-row">
            <div class="toggle-label">White background (PNG → JPG)<small>Replace transparency</small></div>
            <label class="toggle"><input type="checkbox" id="white-bg" onchange="scheduleOptimize()"><span class="toggle-track"></span></label>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <div class="progress-wrap" id="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
          <div class="alert alert-success" id="alert-done">✓ Image optimized successfully!</div>
          <button class="btn btn-accent" id="btn-optimize" onclick="runOptimize()">⚡ Optimize now</button>
          <button class="btn btn-success" id="btn-download" onclick="downloadResult()" style="display:none">↓ Download file</button>
          <button class="btn btn-ghost" onclick="resetAll()" style="margin-top:4px">↺ Reset settings</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
let originalFile=null,originalImg=null,originalSize=0,currentFormat='image/jpeg';
let resultBlob=null,comparePos=0.5,isDraggingCompare=false,optimizeTimer=null;
let aspectRatio=1,currentTab='original',resultCanvas=null;

const dropZone=document.getElementById('drop-zone');
const fileInput=document.getElementById('file-input');

dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadFile(f);});
dropZone.addEventListener('click',e=>{if(e.target===dropZone)fileInput.click();});
fileInput.addEventListener('change',e=>{if(e.target.files[0])loadFile(e.target.files[0]);});

function loadFile(file){
  originalFile=file; originalSize=file.size;
  document.getElementById('file-strip').classList.add('visible');
  document.getElementById('file-name').textContent=file.name;
  document.getElementById('file-size-orig').textContent=fmtBytes(file.size);
  document.getElementById('file-type-badge').textContent=file.type.split('/')[1].toUpperCase();
  document.getElementById('stat-orig').textContent=fmtBytes(file.size);
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      originalImg=img; aspectRatio=img.width/img.height;
      const pi=document.getElementById('preview-img');
      pi.src=ev.target.result; pi.style.display='block';
      document.getElementById('optimized-canvas').style.display='none';
      document.getElementById('compare-wrap').style.display='none';
      document.getElementById('resize-w').value=img.width;
      document.getElementById('resize-h').value=img.height;
      document.getElementById('stat-dims').textContent=`${img.width}×${img.height}`;
      dropZone.style.display='none';
      document.getElementById('editor').classList.add('visible');
      if(file.type==='image/png')setFormatByType('image/png');
      else if(file.type==='image/webp')setFormatByType('image/webp');
      else setFormatByType('image/jpeg');
      drawHistogram(img);
      scheduleOptimize();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function setFormat(btn){
  document.querySelectorAll('.format-btn[data-fmt]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); currentFormat=btn.dataset.fmt; scheduleOptimize();
}
function setFormatByType(type){
  document.querySelectorAll('.format-btn[data-fmt]').forEach(b=>b.classList.toggle('active',b.dataset.fmt===type));
  currentFormat=type;
}

function onQualityChange(slider){
  const v=parseInt(slider.value);
  document.getElementById('quality-val').textContent=v;
  const tip=document.getElementById('quality-tip');
  if(v<40)tip.textContent='LOW';
  else if(v<65)tip.textContent='MEDIUM';
  else if(v<85)tip.textContent='STANDARD';
  else if(v<95)tip.textContent='HIGH';
  else tip.textContent='MAX';
  scheduleOptimize();
}
function updateSlider(s,id){document.getElementById(id).textContent=s.value;}
function toggleResize(cb){document.getElementById('resize-fields').style.display=cb.checked?'flex':'none';if(cb.checked)scheduleOptimize();}

function onDimChange(which){
  if(!originalImg)return;
  if(document.getElementById('ratio-lock').checked){
    if(which==='w'){const w=parseInt(document.getElementById('resize-w').value)||originalImg.width;document.getElementById('resize-h').value=Math.round(w/aspectRatio);}
    else{const h=parseInt(document.getElementById('resize-h').value)||originalImg.height;document.getElementById('resize-w').value=Math.round(h*aspectRatio);}
  }
  scheduleOptimize();
}

function applyPreset(w,h,scale){
  if(!originalImg)return;
  document.getElementById('resize-toggle').checked=true;
  document.getElementById('resize-fields').style.display='flex';
  if(scale==='50%'){document.getElementById('resize-w').value=Math.round(originalImg.width*0.5);document.getElementById('resize-h').value=Math.round(originalImg.height*0.5);}
  else{const r=Math.min(w/originalImg.width,h/originalImg.height);document.getElementById('resize-w').value=Math.round(originalImg.width*r);document.getElementById('resize-h').value=Math.round(originalImg.height*r);}
  scheduleOptimize();
}

function scheduleOptimize(){clearTimeout(optimizeTimer);optimizeTimer=setTimeout(runOptimize,400);}

function runOptimize(){
  if(!originalImg)return;
  const btn=document.getElementById('btn-optimize');
  btn.innerHTML='<span class="spinner"></span> Processing...'; btn.disabled=true;
  const pw=document.getElementById('progress-wrap'),pb=document.getElementById('progress-bar');
  pw.classList.add('visible'); pb.style.width='30%';
  requestAnimationFrame(()=>{
    pb.style.width='70%';
    setTimeout(()=>{
      try{doOptimize();}catch(e){console.error(e);}
      pb.style.width='100%';
      setTimeout(()=>{pw.classList.remove('visible');pb.style.width='0%';btn.innerHTML='⚡ Optimize now';btn.disabled=false;},300);
    },50);
  });
}

function doOptimize(){
  const quality=parseInt(document.getElementById('quality-slider').value)/100;
  const method=document.getElementById('compress-method').value;
  const doResize=document.getElementById('resize-toggle').checked;
  const whiteBg=document.getElementById('white-bg').checked;
  const algo=document.getElementById('resize-algo').value;
  let tW=originalImg.width,tH=originalImg.height;
  if(doResize){tW=parseInt(document.getElementById('resize-w').value)||tW;tH=parseInt(document.getElementById('resize-h').value)||tH;}

  const canvas=document.createElement('canvas');
  canvas.width=tW; canvas.height=tH;
  const ctx=canvas.getContext('2d');
  if(whiteBg||currentFormat==='image/jpeg'){ctx.fillStyle='#ffffff';ctx.fillRect(0,0,tW,tH);}
  ctx.imageSmoothingEnabled=algo!=='pixelated';
  ctx.imageSmoothingQuality=algo==='smooth'?'high':'medium';
  ctx.drawImage(originalImg,0,0,tW,tH);

  const bright=parseInt(document.getElementById('bright-slider').value);
  const contrast=parseInt(document.getElementById('contrast-slider').value);
  const sat=parseInt(document.getElementById('sat-slider').value);
  const sharpen=parseInt(document.getElementById('sharpen-slider').value);
  if(bright!==0||contrast!==0||sat!==0)applyAdjustments(ctx,tW,tH,bright,contrast,sat);
  if(sharpen>0)applySharpen(ctx,tW,tH,sharpen/100);

  let q=quality;
  if(method==='aggressive')q=Math.min(q*0.75,0.7);
  else if(method==='lossless')q=1.0;
  else if(method==='balanced')q=Math.min(q*0.9,0.85);

  canvas.toBlob(blob=>{
    resultBlob=blob; resultCanvas=canvas;
    if(currentTab==='optimized')showOptimizedCanvas(canvas);
    else if(currentTab==='compare')drawCompare(comparePos);

    const pct=((originalSize-blob.size)/originalSize*100).toFixed(1);
    document.getElementById('stat-new').textContent=fmtBytes(blob.size);
    document.getElementById('stat-dims').textContent=`${tW}×${tH}`;
    const el=document.getElementById('stat-saved');
    el.textContent=blob.size<originalSize?`-${pct}%`:`+${Math.abs(pct)}%`;
    el.className=blob.size<originalSize?'stat-value saved':'stat-value up';

    document.getElementById('alert-done').classList.add('visible');
    setTimeout(()=>document.getElementById('alert-done').classList.remove('visible'),3000);
    document.getElementById('btn-download').style.display='flex';
    drawHistogramFromCanvas(canvas);
  },currentFormat,q);
}

function applyAdjustments(ctx,w,h,bright,contrast,sat){
  const id=ctx.getImageData(0,0,w,h),d=id.data;
  const bf=bright*2.55,cf=(259*(contrast+255))/(255*(259-contrast)),sf=1+sat/100;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2];
    if(sat!==0){const gr=0.299*r+0.587*g+0.114*b;r=gr+sf*(r-gr);g=gr+sf*(g-gr);b=gr+sf*(b-gr);}
    if(bright!==0){r+=bf;g+=bf;b+=bf;}
    if(contrast!==0){r=cf*(r-128)+128;g=cf*(g-128)+128;b=cf*(b-128)+128;}
    d[i]=Math.max(0,Math.min(255,r));d[i+1]=Math.max(0,Math.min(255,g));d[i+2]=Math.max(0,Math.min(255,b));
  }
  ctx.putImageData(id,0,0);
}

function applySharpen(ctx,w,h,amount){
  const id=ctx.getImageData(0,0,w,h),d=id.data,out=new Uint8ClampedArray(d);
  const k=[0,-1,0,-1,5,-1,0,-1,0];
  for(let y=1;y<h-1;y++){for(let x=1;x<w-1;x++){for(let c=0;c<3;c++){
    let s=0;
    for(let ky=0;ky<3;ky++)for(let kx=0;kx<3;kx++)s+=d[((y+ky-1)*w+(x+kx-1))*4+c]*k[ky*3+kx];
    const orig=d[(y*w+x)*4+c];
    out[(y*w+x)*4+c]=Math.max(0,Math.min(255,orig+(s-orig)*amount));
  }}}
  ctx.putImageData(new ImageData(out,w,h),0,0);
}

function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['original','optimized','compare'][i]===tab));
  document.getElementById('preview-img').style.display='none';
  document.getElementById('optimized-canvas').style.display='none';
  document.getElementById('compare-wrap').style.display='none';
  if(tab==='original')document.getElementById('preview-img').style.display='block';
  else if(tab==='optimized'&&resultCanvas)showOptimizedCanvas(resultCanvas);
  else if(tab==='compare'&&resultCanvas)setupCompare();
  else document.getElementById('preview-img').style.display='block';
}

function showOptimizedCanvas(src){
  const c=document.getElementById('optimized-canvas');
  c.width=src.width;c.height=src.height;c.getContext('2d').drawImage(src,0,0);c.style.display='block';
}

function setupCompare(){
  const wrap=document.getElementById('compare-wrap'),cmp=document.getElementById('compare-canvas');
  const area=document.getElementById('preview-area'),maxW=area.clientWidth-32;
  const ch=Math.min(Math.round(maxW/aspectRatio),420);
  cmp.width=maxW;cmp.height=ch;wrap.style.display='block';wrap.style.height=ch+'px';

  if(!wrap._done){
    const line=document.createElement('div');line.className='compare-line';
    const handle=document.createElement('div');handle.className='compare-handle';handle.textContent='⟺';
    const lL=document.createElement('div');lL.className='compare-label left';lL.textContent='ORIGINAL';
    const lR=document.createElement('div');lR.className='compare-label right';lR.textContent='OPTIMIZED';
    wrap._line=line;wrap._handle=handle;
    wrap.appendChild(line);wrap.appendChild(handle);wrap.appendChild(lL);wrap.appendChild(lR);
    wrap._done=true;
    const mv=e=>{
      if(!isDraggingCompare)return;
      const rect=cmp.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX;
      comparePos=Math.max(0.02,Math.min(0.98,(cx-rect.left)/rect.width));
      drawCompare(comparePos);
    };
    wrap.addEventListener('mousedown',()=>isDraggingCompare=true);
    window.addEventListener('mouseup',()=>isDraggingCompare=false);
    window.addEventListener('mousemove',mv);
    wrap.addEventListener('touchstart',()=>isDraggingCompare=true,{passive:true});
    window.addEventListener('touchend',()=>isDraggingCompare=false);
    window.addEventListener('touchmove',mv,{passive:true});
  }
  drawCompare(comparePos);
}

function drawCompare(pos){
  const wrap=document.getElementById('compare-wrap'),cmp=document.getElementById('compare-canvas');
  if(!wrap._line)return;
  const ctx=cmp.getContext('2d'),w=cmp.width,h=cmp.height;
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(originalImg,0,0,w,h);
  if(resultCanvas){ctx.save();ctx.beginPath();ctx.rect(pos*w,0,w,h);ctx.clip();ctx.drawImage(resultCanvas,0,0,w,h);ctx.restore();}
  wrap._line.style.left=(pos*100)+'%';
  wrap._handle.style.left=(pos*100)+'%';
}

function drawHistogram(img){
  const t=document.createElement('canvas');t.width=img.width;t.height=img.height;t.getContext('2d').drawImage(img,0,0);drawHistogramFromCanvas(t);
}

function drawHistogramFromCanvas(src){
  const hc=document.getElementById('histogram-canvas'),w=hc.parentElement.clientWidth-24;
  hc.width=w;hc.height=80;const ctx=hc.getContext('2d');
  const s=200,t=document.createElement('canvas');
  t.width=s;t.height=Math.round(s/(src.width/src.height));
  t.getContext('2d').drawImage(src,0,0,t.width,t.height);
  const d=t.getContext('2d').getImageData(0,0,t.width,t.height).data;
  const rh=new Float32Array(256),gh=new Float32Array(256),bh=new Float32Array(256);
  for(let i=0;i<d.length;i+=4){rh[d[i]]++;gh[d[i+1]]++;bh[d[i+2]]++;}
  const mx=Math.max(...rh,...gh,...bh)||1;
  ctx.clearRect(0,0,w,80);
  [[rh,'rgba(255,80,80,0.6)'],[gh,'rgba(80,220,80,0.6)'],[bh,'rgba(80,130,255,0.6)']].forEach(([h2,col])=>{
    ctx.fillStyle=col;
    for(let x=0;x<256;x++){const bh2=(h2[x]/mx)*78;ctx.fillRect((x/256)*w,80-bh2,w/256+1,bh2);}
  });
}

function downloadResult(){
  if(!resultBlob)return;
  const ext=currentFormat.split('/')[1];
  const base=(originalFile?.name||'image').replace(/\.[^.]+$/,'');
  const url=URL.createObjectURL(resultBlob);
  const a=document.createElement('a');a.href=url;a.download=`${base}_optimized.${ext==='jpeg'?'jpg':ext}`;a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

function resetAll(){
  document.getElementById('quality-slider').value=82;document.getElementById('quality-val').textContent='82';document.getElementById('quality-tip').textContent='STANDARD';
  ['sharpen','bright','contrast','sat'].forEach(n=>{document.getElementById(n+'-slider').value=n==='bright'||n==='contrast'||n==='sat'?0:0;document.getElementById(n+'-val').textContent='0';});
  document.getElementById('resize-toggle').checked=false;document.getElementById('resize-fields').style.display='none';
  document.getElementById('compress-method').value='default';
  scheduleOptimize();
}

function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(2)+' MB';}
</script>
</body>
</html>
