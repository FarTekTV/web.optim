<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPTIM — Image Optimizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0f;
    --surface: #161618;
    --border: #2a2a2e;
    --accent: #c8ff00;
    --accent2: #ff6b35;
    --text: #e8e8e6;
    --muted: #6b6b72;
    --success: #3dffa0;
    --mono: 'Space Mono', monospace;
    --display: 'Syne', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,255,0,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,255,0,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrap {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  /* Header */
  header {
    display: flex;
    align-items: baseline;
    gap: 20px;
    margin-bottom: 48px;
  }
  .logo {
    font-family: var(--display);
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--accent);
    line-height: 1;
  }
  .logo span { color: var(--text); }
  .tagline {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    padding-top: 4px;
  }
  .version {
    margin-left: auto;
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: 2px;
  }

  /* Drop Zone */
  #drop-zone {
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    margin-bottom: 32px;
    background: var(--surface);
  }
  #drop-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(200,255,0,0.04) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
  }
  #drop-zone:hover::before,
  #drop-zone.drag-over::before { opacity: 1; }
  #drop-zone:hover,
  #drop-zone.drag-over {
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  #drop-zone.drag-over {
    border-style: solid;
    background: rgba(200,255,0,0.03);
  }

  .drop-icon {
    width: 52px;
    height: 52px;
    margin: 0 auto 20px;
    border: 2px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    transition: all 0.2s;
  }
  #drop-zone:hover .drop-icon {
    border-color: var(--accent);
    color: var(--accent);
    transform: scale(1.05);
  }
  .drop-title {
    font-family: var(--display);
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }
  .drop-sub { color: var(--muted); font-size: 12px; margin-bottom: 20px; line-height: 1.6; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
    border: none;
    text-decoration: none;
  }
  .btn-accent {
    background: var(--accent);
    color: #0e0e0f;
  }
  .btn-accent:hover { background: #d4ff1a; transform: translateY(-1px); }
  .btn-ghost {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-success {
    background: var(--success);
    color: #0e0e0f;
  }
  .btn-success:hover { filter: brightness(1.1); }

  #file-input { display: none; }

  /* Main layout after image loaded */
  .editor {
    display: none;
    gap: 28px;
    grid-template-columns: 1fr 340px;
  }
  .editor.visible { display: grid; }

  /* Preview panel */
  .preview-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .panel-header .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent);
    display: inline-block;
    margin-right: 8px;
  }
  .panel-body { padding: 16px; }

  /* Preview tabs */
  .tab-bar {
    display: flex;
    gap: 2px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }
  .tab {
    padding: 5px 14px;
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    color: var(--muted);
    background: none;
    border: 1px solid transparent;
    font-family: var(--mono);
    transition: all 0.15s;
  }
  .tab.active { color: var(--accent); border-color: var(--accent); background: rgba(200,255,0,0.05); }
  .tab:hover:not(.active) { color: var(--text); }

  .preview-area {
    padding: 16px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: repeating-conic-gradient(#1a1a1c 0% 25%, #141415 0% 50%) 0 0 / 20px 20px;
  }
  .preview-area img, .preview-area canvas {
    max-width: 100%;
    max-height: 420px;
    object-fit: contain;
    display: block;
    image-rendering: auto;
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 0;
    border-top: 1px solid var(--border);
    overflow: hidden;
  }
  .stat {
    flex: 1;
    padding: 12px 16px;
    border-right: 1px solid var(--border);
    text-align: center;
  }
  .stat:last-child { border-right: none; }
  .stat-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .stat-value { font-family: var(--display); font-size: 16px; font-weight: 700; color: var(--text); }
  .stat-value.saved { color: var(--success); }
  .stat-value.orig { color: var(--accent2); }

  /* Controls */
  .controls { display: flex; flex-direction: column; gap: 16px; }

  .control-group {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
  }

  .control-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
    display: block;
  }

  /* Slider */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  input[type="range"] {
    -webkit-appearance: none;
    flex: 1;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    cursor: pointer;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.1s;
  }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }
  .slider-val {
    font-size: 16px;
    font-family: var(--display);
    font-weight: 700;
    color: var(--accent);
    min-width: 36px;
    text-align: right;
  }

  /* Format selector */
  .format-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
  }
  .format-btn {
    padding: 8px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }
  .format-btn:hover { border-color: var(--text); color: var(--text); }
  .format-btn.active { background: rgba(200,255,0,0.08); border-color: var(--accent); color: var(--accent); }

  /* Number inputs */
  .dim-row {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 8px;
  }
  .dim-row .x { color: var(--muted); text-align: center; font-size: 12px; }
  input[type="number"] {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    padding: 8px 10px;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
  input[type="number"]:focus { border-color: var(--accent); }

  /* Toggle switches */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 0;
  }
  .toggle-label { font-size: 12px; color: var(--text); }
  .toggle-label small { display: block; color: var(--muted); font-size: 10px; margin-top: 2px; }
  .toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }
  .toggle input { display: none; }
  .toggle-track {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-track::after {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; top: 3px;
    background: var(--muted);
    border-radius: 50%;
    transition: all 0.2s;
  }
  .toggle input:checked + .toggle-track { background: rgba(200,255,0,0.2); }
  .toggle input:checked + .toggle-track::after {
    transform: translateX(16px);
    background: var(--accent);
  }

  /* Select */
  select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 8px 10px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.15s;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b6b72'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }
  select:focus { border-color: var(--accent); }

  /* Actions */
  .actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .actions .btn { justify-content: center; width: 100%; }

  /* Progress bar */
  .progress-wrap {
    display: none;
    background: var(--border);
    border-radius: 2px;
    height: 3px;
    overflow: hidden;
  }
  .progress-wrap.visible { display: block; }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  /* Comparison slider */
  .compare-wrap {
    position: relative;
    overflow: hidden;
    cursor: col-resize;
    user-select: none;
  }
  .compare-wrap canvas { display: block; width: 100%; }
  .compare-line {
    position: absolute;
    top: 0; bottom: 0;
    width: 2px;
    background: var(--accent);
    transform: translateX(-50%);
    pointer-events: none;
  }
  .compare-handle {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 36px; height: 36px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: #0e0e0f;
    pointer-events: none;
    font-weight: 900;
    box-shadow: 0 2px 12px rgba(200,255,0,0.4);
  }
  .compare-label {
    position: absolute;
    top: 10px;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    background: rgba(0,0,0,0.7);
    padding: 4px 8px;
    border-radius: 2px;
    pointer-events: none;
  }
  .compare-label.left { left: 10px; color: var(--accent2); border: 1px solid var(--accent2); }
  .compare-label.right { right: 10px; color: var(--accent); border: 1px solid var(--accent); }

  /* Histogram */
  #histogram-canvas {
    width: 100%;
    height: 80px;
    display: block;
    border-radius: 2px;
  }

  /* Alert */
  .alert {
    padding: 10px 14px;
    border-radius: 2px;
    font-size: 12px;
    margin-bottom: 12px;
    display: none;
    gap: 8px;
    align-items: center;
  }
  .alert.visible { display: flex; }
  .alert-success { background: rgba(61,255,160,0.1); border: 1px solid rgba(61,255,160,0.3); color: var(--success); }
  .alert-info { background: rgba(200,255,0,0.08); border: 1px solid rgba(200,255,0,0.2); color: var(--accent); }

  /* Separator */
  .sep {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* Responsive */
  @media (max-width: 780px) {
    .editor.visible { grid-template-columns: 1fr; }
    header { flex-wrap: wrap; }
  }

  /* Anim */
  @keyframes fadein {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .editor.visible { animation: fadein 0.3s ease; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    border-radius: 2px;
    font-weight: 700;
  }
  .badge-new { background: rgba(200,255,0,0.15); color: var(--accent); border: 1px solid rgba(200,255,0,0.3); }

  /* File info strip */
  .file-strip {
    display: none;
    align-items: center;
    gap: 14px;
    padding: 10px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 12px;
  }
  .file-strip.visible { display: flex; }
  .file-strip .fname { color: var(--text); font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
  .file-strip .fsize { color: var(--muted); }
  .file-strip .ftype { background: rgba(255,107,53,0.15); color: var(--accent2); border: 1px solid rgba(255,107,53,0.3); padding: 2px 8px; border-radius: 2px; font-size: 10px; letter-spacing: 1px; font-weight: 700; }
  .file-strip .change-btn { margin-left: auto; }

  /* Spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(14,14,15,0.3);
    border-top-color: #0e0e0f;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="logo">OPTIM<span>.</span></div>
      <div class="tagline">Image Optimizer — 100% Client Side</div>
    </div>
    <div class="version">v1.0.0</div>
  </header>

  <!-- Drop zone -->
  <div id="drop-zone">
    <div class="drop-icon">⬆</div>
    <div class="drop-title">Glisser une image ici</div>
    <div class="drop-sub">
      JPG, PNG, WebP, GIF, BMP, TIFF supportés<br>
      Traitement 100% local — aucun upload serveur
    </div>
    <button class="btn btn-accent" onclick="document.getElementById('file-input').click()">
      ⊕ Parcourir les fichiers
    </button>
    <input type="file" id="file-input" accept="image/*">
  </div>

  <!-- File info strip -->
  <div class="file-strip" id="file-strip">
    <span class="ftype" id="file-type-badge">JPG</span>
    <span class="fname" id="file-name">image.jpg</span>
    <span class="fsize" id="file-size-orig">— KB</span>
    <button class="btn btn-ghost change-btn" onclick="document.getElementById('file-input').click()" style="padding:6px 14px">↺ Changer</button>
  </div>

  <!-- Editor -->
  <div class="editor" id="editor">
    <!-- Preview -->
    <div class="preview-panel">
      <div class="panel">
        <div class="tab-bar">
          <button class="tab active" onclick="switchTab('original')">Original</button>
          <button class="tab" onclick="switchTab('optimized')">Optimisé</button>
          <button class="tab" onclick="switchTab('compare')">Comparaison ↔</button>
        </div>
        <div class="preview-area" id="preview-area">
          <img id="preview-img" src="" alt="preview" style="display:none">
          <canvas id="optimized-canvas" style="display:none"></canvas>
          <canvas id="compare-canvas" style="display:none" class="compare-wrap"></canvas>
        </div>
        <div class="stats-bar">
          <div class="stat">
            <div class="stat-label">Original</div>
            <div class="stat-value orig" id="stat-orig">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">Optimisé</div>
            <div class="stat-value" id="stat-new">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">Réduction</div>
            <div class="stat-value saved" id="stat-saved">—</div>
          </div>
          <div class="stat">
            <div class="stat-label">Dimensions</div>
            <div class="stat-value" id="stat-dims">—</div>
          </div>
        </div>
      </div>

      <!-- Histogram -->
      <div class="panel">
        <div class="panel-header">
          <span><span class="dot"></span>Histogramme</span>
          <span id="hist-mode" style="font-size:10px">RGB</span>
        </div>
        <div class="panel-body" style="padding:12px">
          <canvas id="histogram-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">

      <!-- Format -->
      <div class="control-group">
        <div class="panel-header"><span><span class="dot" style="background:var(--accent2)"></span>Format de sortie</span></div>
        <div class="panel-body">
          <div class="format-grid">
            <button class="format-btn active" data-fmt="image/jpeg" onclick="setFormat(this)">JPG</button>
            <button class="format-btn" data-fmt="image/webp" onclick="setFormat(this)">WebP</button>
            <button class="format-btn" data-fmt="image/png" onclick="setFormat(this)">PNG</button>
            <button class="format-btn" data-fmt="image/gif" onclick="setFormat(this)" disabled style="opacity:0.3;cursor:not-allowed" title="Non supporté">GIF</button>
          </div>
        </div>
      </div>

      <!-- Quality -->
      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Qualité & Compression</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:16px">
          <div>
            <label class="control-label">Qualité <span id="quality-tip" style="color:var(--accent);font-size:9px;letter-spacing:1px">STANDARD</span></label>
            <div class="slider-row">
              <input type="range" id="quality-slider" min="1" max="100" value="82" oninput="onQualityChange(this)">
              <div class="slider-val" id="quality-val">82</div>
            </div>
          </div>
          <div>
            <label class="control-label">Méthode de compression</label>
            <select id="compress-method" onchange="scheduleOptimize()">
              <option value="default">Auto (recommandé)</option>
              <option value="aggressive">Aggressive — max compression</option>
              <option value="lossless">Lossless — sans perte</option>
              <option value="balanced">Balanced — équilibré</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Resize -->
      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Redimensionner</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          <div class="toggle-row">
            <div class="toggle-label">
              Redimensionner
              <small>Activer le resize</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="resize-toggle" onchange="toggleResize(this)">
              <span class="toggle-track"></span>
            </label>
          </div>
          <div id="resize-fields" style="display:none;flex-direction:column;gap:10px">
            <div class="dim-row">
              <div>
                <label class="control-label" style="margin-bottom:6px">Largeur</label>
                <input type="number" id="resize-w" placeholder="px" oninput="onDimChange('w')">
              </div>
              <div class="x">×</div>
              <div>
                <label class="control-label" style="margin-bottom:6px">Hauteur</label>
                <input type="number" id="resize-h" placeholder="px" oninput="onDimChange('h')">
              </div>
            </div>
            <div class="toggle-row">
              <div class="toggle-label">
                Ratio proportionnel
                <small>Conserver les proportions</small>
              </div>
              <label class="toggle">
                <input type="checkbox" id="ratio-lock" checked>
                <span class="toggle-track"></span>
              </label>
            </div>
            <div>
              <label class="control-label">Algorithme de redim.</label>
              <select id="resize-algo" onchange="scheduleOptimize()">
                <option value="default">Bicubique (défaut)</option>
                <option value="smooth">Lissage haute qualité</option>
                <option value="pixelated">Pixelisé (pixel art)</option>
              </select>
            </div>
            <div>
              <label class="control-label">Preset rapide</label>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
                <button class="format-btn" onclick="applyPreset(1920,1080)">1080p</button>
                <button class="format-btn" onclick="applyPreset(1280,720)">720p</button>
                <button class="format-btn" onclick="applyPreset(800,600)">800px</button>
                <button class="format-btn" onclick="applyPreset(400,400)">400px</button>
                <button class="format-btn" onclick="applyPreset(200,200)">Thumb</button>
                <button class="format-btn" onclick="applyPreset(null,null,'50%')">×½</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Adjustments -->
      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Ajustements image</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          <div>
            <label class="control-label">Netteté</label>
            <div class="slider-row">
              <input type="range" id="sharpen-slider" min="0" max="100" value="0" oninput="updateSlider(this,'sharpen-val');scheduleOptimize()">
              <div class="slider-val" id="sharpen-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Luminosité</label>
            <div class="slider-row">
              <input type="range" id="bright-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'bright-val');scheduleOptimize()">
              <div class="slider-val" id="bright-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Contraste</label>
            <div class="slider-row">
              <input type="range" id="contrast-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'contrast-val');scheduleOptimize()">
              <div class="slider-val" id="contrast-val">0</div>
            </div>
          </div>
          <div>
            <label class="control-label">Saturation</label>
            <div class="slider-row">
              <input type="range" id="sat-slider" min="-100" max="100" value="0" oninput="updateSlider(this,'sat-val');scheduleOptimize()">
              <div class="slider-val" id="sat-val">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Options -->
      <div class="control-group">
        <div class="panel-header"><span><span class="dot"></span>Options avancées</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <div class="toggle-row">
            <div class="toggle-label">
              Supprimer les métadonnées EXIF
              <small>GPS, appareil, date, etc.</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="strip-exif" checked>
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="sep"></div>
          <div class="toggle-row">
            <div class="toggle-label">
              Progressive JPEG
              <small>Chargement progressif</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="progressive" onchange="scheduleOptimize()">
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="sep"></div>
          <div class="toggle-row">
            <div class="toggle-label">
              Fond blanc (PNG → JPG)
              <small>Remplace la transparence</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="white-bg" onchange="scheduleOptimize()">
              <span class="toggle-track"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="control-group">
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <div class="progress-wrap" id="progress-wrap">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          <div class="alert alert-success" id="alert-done">
            ✓ Image optimisée avec succès !
          </div>
          <button class="btn btn-accent" id="btn-optimize" onclick="runOptimize()">
            ⚡ Optimiser maintenant
          </button>
          <button class="btn btn-success" id="btn-download" onclick="downloadResult()" style="display:none">
            ↓ Télécharger le fichier
          </button>
          <button class="btn btn-ghost" onclick="resetAll()" style="margin-top:4px">
            ↺ Réinitialiser
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// State
let originalFile = null;
let originalImg = null;
let originalSize = 0;
let currentFormat = 'image/jpeg';
let resultBlob = null;
let comparePos = 0.5;
let isDraggingCompare = false;
let optimizeTimer = null;
let aspectRatio = 1;
let currentTab = 'original';
let resultCanvas = null;

// Init
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadFile(f);
});
dropZone.addEventListener('click', e => { if (e.target === dropZone) fileInput.click(); });
fileInput.addEventListener('change', e => { if (e.target.files[0]) loadFile(e.target.files[0]); });

function loadFile(file) {
  originalFile = file;
  originalSize = file.size;

  // File strip
  const strip = document.getElementById('file-strip');
  strip.classList.add('visible');
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('file-size-orig').textContent = formatBytes(file.size);
  document.getElementById('file-type-badge').textContent = file.type.split('/')[1].toUpperCase();
  document.getElementById('stat-orig').textContent = formatBytes(file.size);

  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      originalImg = img;
      aspectRatio = img.width / img.height;

      // Show preview
      const previewImg = document.getElementById('preview-img');
      previewImg.src = ev.target.result;
      previewImg.style.display = 'block';
      document.getElementById('optimized-canvas').style.display = 'none';
      document.getElementById('compare-canvas').style.display = 'none';

      // Resize fields default values
      document.getElementById('resize-w').value = img.width;
      document.getElementById('resize-h').value = img.height;
      document.getElementById('stat-dims').textContent = `${img.width}×${img.height}`;

      // Show editor
      dropZone.style.display = 'none';
      document.getElementById('editor').classList.add('visible');

      // Auto-detect format
      if (file.type === 'image/png') { setFormatByType('image/png'); }
      else if (file.type === 'image/webp') { setFormatByType('image/webp'); }
      else { setFormatByType('image/jpeg'); }

      // Draw histogram
      drawHistogram(img);

      // Auto-optimize
      scheduleOptimize();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function setFormat(btn) {
  document.querySelectorAll('.format-btn[data-fmt]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFormat = btn.dataset.fmt;
  scheduleOptimize();
}

function setFormatByType(type) {
  document.querySelectorAll('.format-btn[data-fmt]').forEach(b => {
    b.classList.toggle('active', b.dataset.fmt === type);
  });
  currentFormat = type;
}

function onQualityChange(slider) {
  const v = parseInt(slider.value);
  document.getElementById('quality-val').textContent = v;
  const tip = document.getElementById('quality-tip');
  if (v < 40) tip.textContent = 'FAIBLE';
  else if (v < 65) tip.textContent = 'MOYEN';
  else if (v < 85) tip.textContent = 'STANDARD';
  else if (v < 95) tip.textContent = 'ÉLEVÉ';
  else tip.textContent = 'MAX';
  scheduleOptimize();
}

function updateSlider(slider, valId) {
  document.getElementById(valId).textContent = slider.value;
}

function toggleResize(cb) {
  document.getElementById('resize-fields').style.display = cb.checked ? 'flex' : 'none';
  if (cb.checked) scheduleOptimize();
}

function onDimChange(which) {
  if (!originalImg) return;
  const lock = document.getElementById('ratio-lock').checked;
  if (lock) {
    if (which === 'w') {
      const w = parseInt(document.getElementById('resize-w').value) || originalImg.width;
      document.getElementById('resize-h').value = Math.round(w / aspectRatio);
    } else {
      const h = parseInt(document.getElementById('resize-h').value) || originalImg.height;
      document.getElementById('resize-w').value = Math.round(h * aspectRatio);
    }
  }
  scheduleOptimize();
}

function applyPreset(w, h, scale) {
  if (!originalImg) return;
  document.getElementById('resize-toggle').checked = true;
  document.getElementById('resize-fields').style.display = 'flex';
  if (scale === '50%') {
    document.getElementById('resize-w').value = Math.round(originalImg.width * 0.5);
    document.getElementById('resize-h').value = Math.round(originalImg.height * 0.5);
  } else {
    // fit to box keeping ratio
    const ratio = Math.min(w / originalImg.width, h / originalImg.height);
    document.getElementById('resize-w').value = Math.round(originalImg.width * ratio);
    document.getElementById('resize-h').value = Math.round(originalImg.height * ratio);
  }
  scheduleOptimize();
}

function scheduleOptimize() {
  clearTimeout(optimizeTimer);
  optimizeTimer = setTimeout(runOptimize, 400);
}

function runOptimize() {
  if (!originalImg) return;
  const btn = document.getElementById('btn-optimize');
  btn.innerHTML = '<span class="spinner"></span> En cours...';
  btn.disabled = true;

  const pw = document.getElementById('progress-wrap');
  const pb = document.getElementById('progress-bar');
  pw.classList.add('visible');
  pb.style.width = '30%';

  requestAnimationFrame(() => {
    pb.style.width = '70%';
    setTimeout(() => {
      try { doOptimize(); } catch(e) { console.error(e); }
      pb.style.width = '100%';
      setTimeout(() => {
        pw.classList.remove('visible');
        pb.style.width = '0%';
        btn.innerHTML = '⚡ Optimiser maintenant';
        btn.disabled = false;
      }, 300);
    }, 50);
  });
}

function doOptimize() {
  const quality = parseInt(document.getElementById('quality-slider').value) / 100;
  const method = document.getElementById('compress-method').value;
  const doResize = document.getElementById('resize-toggle').checked;
  const whiteBg = document.getElementById('white-bg').checked;
  const algo = document.getElementById('resize-algo').value;

  let targetW = originalImg.width;
  let targetH = originalImg.height;
  if (doResize) {
    targetW = parseInt(document.getElementById('resize-w').value) || originalImg.width;
    targetH = parseInt(document.getElementById('resize-h').value) || originalImg.height;
  }

  // Create offscreen canvas
  const canvas = document.createElement('canvas');
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext('2d');

  // Background
  if (whiteBg || (currentFormat === 'image/jpeg')) {
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, targetW, targetH);
  }

  // Resize algorithm
  ctx.imageSmoothingEnabled = algo !== 'pixelated';
  ctx.imageSmoothingQuality = algo === 'smooth' ? 'high' : 'medium';
  if (algo === 'pixelated') {
    ctx.msImageSmoothingEnabled = false;
  }

  ctx.drawImage(originalImg, 0, 0, targetW, targetH);

  // Apply adjustments
  const bright = parseInt(document.getElementById('bright-slider').value);
  const contrast = parseInt(document.getElementById('contrast-slider').value);
  const sat = parseInt(document.getElementById('sat-slider').value);
  const sharpen = parseInt(document.getElementById('sharpen-slider').value);

  if (bright !== 0 || contrast !== 0 || sat !== 0) {
    applyAdjustments(ctx, targetW, targetH, bright, contrast, sat);
  }
  if (sharpen > 0) {
    applySharpen(ctx, targetW, targetH, sharpen / 100);
  }

  // Compression method adjustments
  let q = quality;
  if (method === 'aggressive') q = Math.min(q * 0.75, 0.7);
  else if (method === 'lossless') q = 1.0;
  else if (method === 'balanced') q = Math.min(q * 0.9, 0.85);

  // Encode
  canvas.toBlob(blob => {
    resultBlob = blob;
    resultCanvas = canvas;

    // Show result
    switchTabToResult(canvas);

    // Stats
    const savedPct = ((originalSize - blob.size) / originalSize * 100).toFixed(1);
    document.getElementById('stat-new').textContent = formatBytes(blob.size);
    document.getElementById('stat-dims').textContent = `${targetW}×${targetH}`;
    const savedEl = document.getElementById('stat-saved');
    if (blob.size < originalSize) {
      savedEl.textContent = `-${savedPct}%`;
      savedEl.className = 'stat-value saved';
    } else {
      savedEl.textContent = `+${Math.abs(savedPct)}%`;
      savedEl.className = 'stat-value orig';
    }

    // Alert
    document.getElementById('alert-done').classList.add('visible');
    setTimeout(() => document.getElementById('alert-done').classList.remove('visible'), 3000);

    // Download button
    document.getElementById('btn-download').style.display = 'flex';

    // Redraw histogram with result
    drawHistogramFromCanvas(canvas);

  }, currentFormat, q);
}

function switchTabToResult(canvas) {
  if (currentTab === 'optimized') {
    showOptimizedCanvas(canvas);
  } else if (currentTab === 'compare') {
    drawCompare(comparePos);
  }
}

function applyAdjustments(ctx, w, h, bright, contrast, sat) {
  const imgData = ctx.getImageData(0, 0, w, h);
  const data = imgData.data;
  const brightF = bright * 2.55;
  const contrastF = (259 * (contrast + 255)) / (255 * (259 - contrast));
  const satF = 1 + sat / 100;

  for (let i = 0; i < data.length; i += 4) {
    let r = data[i], g = data[i+1], b = data[i+2];

    // Saturation
    if (sat !== 0) {
      const gray = 0.299 * r + 0.587 * g + 0.114 * b;
      r = gray + satF * (r - gray);
      g = gray + satF * (g - gray);
      b = gray + satF * (b - gray);
    }

    // Brightness
    if (bright !== 0) { r += brightF; g += brightF; b += brightF; }

    // Contrast
    if (contrast !== 0) {
      r = contrastF * (r - 128) + 128;
      g = contrastF * (g - 128) + 128;
      b = contrastF * (b - 128) + 128;
    }

    data[i] = Math.max(0, Math.min(255, r));
    data[i+1] = Math.max(0, Math.min(255, g));
    data[i+2] = Math.max(0, Math.min(255, b));
  }
  ctx.putImageData(imgData, 0, 0);
}

function applySharpen(ctx, w, h, amount) {
  const imgData = ctx.getImageData(0, 0, w, h);
  const data = imgData.data;
  const out = new Uint8ClampedArray(data);
  const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
  const kw = 3;
  const half = Math.floor(kw / 2);

  for (let y = half; y < h - half; y++) {
    for (let x = half; x < w - half; x++) {
      for (let c = 0; c < 3; c++) {
        let sum = 0;
        for (let ky = 0; ky < kw; ky++) {
          for (let kx = 0; kx < kw; kx++) {
            const py = y + ky - half, px = x + kx - half;
            sum += data[(py * w + px) * 4 + c] * kernel[ky * kw + kx];
          }
        }
        const orig = data[(y * w + x) * 4 + c];
        out[(y * w + x) * 4 + c] = Math.max(0, Math.min(255, orig + (sum - orig) * amount));
      }
    }
  }
  ctx.putImageData(new ImageData(out, w, h), 0, 0);
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['original','optimized','compare'][i] === tab);
  });

  const previewImg = document.getElementById('preview-img');
  const optCanvas = document.getElementById('optimized-canvas');
  const cmpCanvas = document.getElementById('compare-canvas');

  previewImg.style.display = 'none';
  optCanvas.style.display = 'none';
  cmpCanvas.style.display = 'none';

  if (tab === 'original') {
    previewImg.style.display = 'block';
  } else if (tab === 'optimized' && resultCanvas) {
    showOptimizedCanvas(resultCanvas);
  } else if (tab === 'compare' && resultCanvas) {
    setupCompare();
  } else if (tab === 'optimized' || tab === 'compare') {
    // No result yet, show original
    previewImg.style.display = 'block';
  }
}

function showOptimizedCanvas(srcCanvas) {
  const optCanvas = document.getElementById('optimized-canvas');
  optCanvas.width = srcCanvas.width;
  optCanvas.height = srcCanvas.height;
  optCanvas.getContext('2d').drawImage(srcCanvas, 0, 0);
  optCanvas.style.display = 'block';
  document.getElementById('preview-img').style.display = 'none';
  document.getElementById('compare-canvas').style.display = 'none';
}

function setupCompare() {
  const cmpCanvas = document.getElementById('compare-canvas');
  const area = document.getElementById('preview-area');
  const maxW = area.clientWidth - 32;

  // Use original img aspect
  const h = Math.round(maxW / aspectRatio);
  cmpCanvas.width = maxW;
  cmpCanvas.height = Math.min(h, 420);

  // Add compare line overlay
  if (!cmpCanvas._setupDone) {
    const line = document.createElement('div');
    line.className = 'compare-line';
    const handle = document.createElement('div');
    handle.className = 'compare-handle';
    handle.textContent = '⟺';
    const lblL = document.createElement('div');
    lblL.className = 'compare-label left';
    lblL.textContent = 'ORIGINAL';
    const lblR = document.createElement('div');
    lblR.className = 'compare-label right';
    lblR.textContent = 'OPTIMISÉ';

    const wrap = cmpCanvas.parentElement;
    // Make wrap relative, it already has class compare-wrap
    wrap.style.position = 'relative';
    cmpCanvas._line = line;
    cmpCanvas._handle = handle;
    cmpCanvas.parentElement.appendChild(line);
    cmpCanvas.parentElement.appendChild(handle);
    cmpCanvas.parentElement.appendChild(lblL);
    cmpCanvas.parentElement.appendChild(lblR);
    cmpCanvas._setupDone = true;

    const onMove = e => {
      if (!isDraggingCompare) return;
      const rect = cmpCanvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      comparePos = Math.max(0.02, Math.min(0.98, (clientX - rect.left) / rect.width));
      drawCompare(comparePos);
    };
    cmpCanvas.parentElement.addEventListener('mousedown', () => isDraggingCompare = true);
    window.addEventListener('mouseup', () => isDraggingCompare = false);
    window.addEventListener('mousemove', onMove);
    cmpCanvas.parentElement.addEventListener('touchstart', () => isDraggingCompare = true, {passive:true});
    window.addEventListener('touchend', () => isDraggingCompare = false);
    window.addEventListener('touchmove', onMove, {passive:true});
  }

  document.getElementById('preview-img').style.display = 'none';
  document.getElementById('optimized-canvas').style.display = 'none';
  cmpCanvas.style.display = 'block';
  drawCompare(comparePos);
}

function drawCompare(pos) {
  const cmpCanvas = document.getElementById('compare-canvas');
  if (!cmpCanvas._line) return;
  const ctx = cmpCanvas.getContext('2d');
  const w = cmpCanvas.width, h = cmpCanvas.height;
  ctx.clearRect(0, 0, w, h);

  // Draw original (left)
  ctx.save();
  ctx.drawImage(originalImg, 0, 0, w, h);
  ctx.restore();

  // Draw optimized (right)
  if (resultCanvas) {
    ctx.save();
    ctx.beginPath();
    ctx.rect(pos * w, 0, w, h);
    ctx.clip();
    ctx.drawImage(resultCanvas, 0, 0, w, h);
    ctx.restore();
  }

  // Update line position
  const pxPos = pos * 100;
  cmpCanvas._line.style.left = pxPos + '%';
  cmpCanvas._handle.style.left = pxPos + '%';
}

function drawHistogram(img) {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = img.width;
  tempCanvas.height = img.height;
  const ctx = tempCanvas.getContext('2d');
  ctx.drawImage(img, 0, 0);
  drawHistogramFromCanvas(tempCanvas);
}

function drawHistogramFromCanvas(srcCanvas) {
  const hCanvas = document.getElementById('histogram-canvas');
  const w = hCanvas.parentElement.clientWidth - 24;
  hCanvas.width = w;
  hCanvas.height = 80;
  const ctx = hCanvas.getContext('2d');

  // Sample at reduced size for perf
  const s = 200;
  const tmp = document.createElement('canvas');
  tmp.width = s; tmp.height = Math.round(s / (srcCanvas.width / srcCanvas.height));
  const tc = tmp.getContext('2d');
  tc.drawImage(srcCanvas, 0, 0, tmp.width, tmp.height);
  const data = tc.getImageData(0, 0, tmp.width, tmp.height).data;

  const rh = new Float32Array(256), gh = new Float32Array(256), bh = new Float32Array(256);
  for (let i = 0; i < data.length; i += 4) {
    rh[data[i]]++; gh[data[i+1]]++; bh[data[i+2]]++;
  }
  const maxVal = Math.max(...rh, ...gh, ...bh) || 1;

  ctx.clearRect(0, 0, w, 80);

  [[rh,'rgba(255,80,80,0.6)'],[gh,'rgba(80,220,80,0.6)'],[bh,'rgba(80,130,255,0.6)']].forEach(([hist, color]) => {
    ctx.beginPath();
    ctx.fillStyle = color;
    for (let x = 0; x < 256; x++) {
      const bx = (x / 256) * w;
      const bh2 = (hist[x] / maxVal) * 78;
      ctx.fillRect(bx, 80 - bh2, w / 256 + 1, bh2);
    }
    ctx.fill();
  });
}

function downloadResult() {
  if (!resultBlob) return;
  const ext = currentFormat.split('/')[1];
  const baseName = (originalFile?.name || 'image').replace(/\.[^.]+$/, '');
  const url = URL.createObjectURL(resultBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${baseName}_optimized.${ext === 'jpeg' ? 'jpg' : ext}`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function resetAll() {
  document.getElementById('quality-slider').value = 82;
  document.getElementById('quality-val').textContent = '82';
  document.getElementById('sharpen-slider').value = 0;
  document.getElementById('sharpen-val').textContent = '0';
  document.getElementById('bright-slider').value = 0;
  document.getElementById('bright-val').textContent = '0';
  document.getElementById('contrast-slider').value = 0;
  document.getElementById('contrast-val').textContent = '0';
  document.getElementById('sat-slider').value = 0;
  document.getElementById('sat-val').textContent = '0';
  document.getElementById('resize-toggle').checked = false;
  document.getElementById('resize-fields').style.display = 'none';
  document.getElementById('compress-method').value = 'default';
  scheduleOptimize();
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1024/1024).toFixed(2) + ' MB';
}
</script>
</body>
</html>
